---
phase: 03-core-grading-experience
plan: 04
type: execute
wave: 4
depends_on: [03-03]
files_modified:
  - src/export/analytics.py
  - src/api/app.py
  - pyproject.toml
autonomous: true
requirements:
  - EXPT-01
  - EXPT-02
  - EXPT-03
  - EXPT-04
user_setup: []

must_haves:
  truths:
    - "User can export grading results to CSV via GET /api/sessions/{id}/export/csv"
    - "User can export grading results to JSON via GET /api/sessions/{id}/export/json"
    - "User can export grading results to Excel via GET /api/sessions/{id}/export/excel"
    - "CSV export includes student identifiers, per-question grades, total, and feedback"
    - "Excel export includes formatted headers, column width adjustment, and French localization"
    - "JSON export includes complete session data with dual-LLM audit trail"
  artifacts:
    - path: "src/export/analytics.py"
      provides: "DataExporter.export_excel() method"
      exports: ["export_excel"]
    - path: "src/api/app.py"
      provides: "GET /sessions/{id}/export/{format} endpoint"
      exports: ["export_session"]
    - path: "pyproject.toml"
      provides: "openpyxl dependency"
      contains: "openpyxl"
  key_links:
    - from: "src/api/app.py"
      to: "src/export/analytics.py"
      via: "DataExporter import and usage"
      pattern: "from export.analytics import DataExporter"
    - from: "src/export/analytics.py"
      to: "openpyxl"
      via: "Excel generation library"
      pattern: "from openpyxl import Workbook"
    - from: "src/export/analytics.py"
      to: "src/core/models.py"
      via: "GradingSession data export"
      pattern: "GradingSession, GradedCopy"
---

<objective>
Implement multi-format export (CSV, JSON, Excel) for grading results.

This plan adds Excel export capability using openpyxl and enhances existing CSV/JSON exports to include complete student data, per-question grades, feedback, and dual-LLM audit information.

Purpose: Enable teachers to export graded results in their preferred format for integration with school systems (Pronote expects CSV/Excel) and record-keeping.

Output: Excel export method, enhanced export endpoint with format selection, formatted output files.
</objective>

<execution_context>
@/home/olivier/.claude/get-shit-done/workflows/execute-plan.md
@/home/olivier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-core-grading-experience/03-CONTEXT.md
@.planning/phases/03-core-grading-experience/03-RESEARCH.md
@.planning/phases/03-core-grading-experience/03-01-PLAN.md
@.planning/phases/03-core-grading-experience/03-03-PLAN.md
@src/export/analytics.py
@src/api/app.py
@pyproject.toml

<interfaces>
<!-- From src/export/analytics.py - Existing export methods -->
```python
class DataExporter:
    def __init__(self, session: GradingSession, output_dir: str = None):
        self.session = session
        self.output_dir = Path(output_dir or "outputs/reports")
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def export_csv(self, filename: str = None) -> str:
        """Export grades as CSV. Returns file path."""
        # Already implemented - writes to output_dir

    def export_json(self, filename: str = None) -> str:
        """Export session data as comprehensive JSON. Returns file path."""
        # Already implemented - writes to output_dir

    def export_all(self, options: ExportOptions = None) -> Dict[str, str]:
        """Export all data in specified formats."""
```

<!-- From src/api/app.py - Existing export endpoint (lines 1035-1069) -->
```python
@app.get("/api/sessions/{session_id}/export/{format}")
async def export_session(session_id: str, format: str, current_user = Depends(get_current_user)):
    """Export session results in the specified format."""
    from export.analytics import DataExporter

    user_id = current_user.id
    store = SessionStore(session_id, user_id=user_id)
    session = store.load_session()

    if not session:
        raise HTTPException(status_code=404, detail="Session not found")

    reports_dir = store.get_reports_dir()
    exporter = DataExporter(session, str(reports_dir))

    if format == "csv":
        path = exporter.export_csv()
    elif format == "json":
        path = exporter.export_json()
    else:
        raise HTTPException(status_code=400, detail=f"Unsupported format: {format}")

    return StreamingResponse(...)
```

<!-- User decision from CONTEXT.md - Export requirements -->
- CSV content: Student ID, per-question grades, total, brief feedback
- Excel format: Formatted table with headers and styling
- File naming: Date + session ID (e.g., "grading_2026-02-27_session-abc123.csv")
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install openpyxl dependency</name>
  <files>pyproject.toml</files>
  <action>
Add openpyxl to project dependencies.

Check pyproject.toml for dependencies section and add:

```toml
dependencies = [
    # ... existing dependencies
    "openpyxl>=3.1.0,<4.0.0",  # Excel export with formatting
]
```

Then install:
```bash
pip install openpyxl==3.1.5
```

Verify installation:
```bash
python -c "import openpyxl; print(openpyxl.__version__)"
```

This adds Excel generation capability with cell formatting, styling, and column width adjustment.
</action>
  <verify>
grep "openpyxl" pyproject.toml && python -c "import openpyxl; print('OK')"
</verify>
  <done>
openpyxl package installed and available for Excel export.
</done>
</task>

<task type="auto">
  <name>Task 2: Add Excel export method to DataExporter</name>
  <files>src/export/analytics.py</files>
  <action>
Add export_excel() method to DataExporter class:

```python
def export_excel(self, filename: str = None) -> str:
    """
    Export session results as formatted Excel file.

    Creates a professional Excel file with:
    - Styled header row (bold, colored background)
    - Auto-adjusted column widths
    - All student data: names, per-question grades, totals, feedback

    Args:
        filename: Output filename (auto-generated if None)

    Returns:
        Path to exported Excel file
    """
    from openpyxl import Workbook
    from openpyxl.styles import Font, Alignment, PatternFill

    if filename is None:
        date_str = datetime.now().strftime("%Y-%m-%d")
        filename = f"correction_{date_str}_{self.session.session_id[:8]}.xlsx"

    output_path = self.output_dir / filename

    wb = Workbook()
    ws = wb.active
    ws.title = "Résultats"

    # Define header style
    header_font = Font(bold=True, color="FFFFFF")
    header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
    header_alignment = Alignment(horizontal="center", vertical="center")

    # Get all question IDs (sorted)
    question_ids = set()
    for graded in self.session.graded_copies:
        question_ids.update(graded.grades.keys())
    question_ids = sorted(question_ids, key=lambda x: (len(x), x))

    # Write header row
    headers = ["Nom élève", "Total", "Note maximale"]
    headers.extend([f"Q{qid}" for qid in question_ids])
    headers.append("Appréciation")

    for col_num, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col_num, value=header)
        cell.font = header_font
        cell.fill = header_fill
        cell.alignment = header_alignment

    # Write data rows
    for row_num, graded in enumerate(self.session.graded_copies, 2):
        # Find student name from copy
        copy = next((c for c in self.session.copies if c.id == graded.copy_id), None)
        student_name = copy.student_name if copy else "Anonyme"

        # Basic info
        ws.cell(row=row_num, column=1, value=student_name)
        ws.cell(row=row_num, column=2, value=graded.total_score)
        ws.cell(row=row_num, column=3, value=graded.max_score)

        # Per-question grades
        for col_num, qid in enumerate(question_ids, 4):
            grade = graded.grades.get(qid, "")
            ws.cell(row=row_num, column=col_num, value=grade)

        # Feedback
        feedback_col = 4 + len(question_ids)
        ws.cell(row=row_num, column=feedback_col, value=graded.feedback or "")

    # Auto-adjust column widths
    for column in ws.columns:
        max_length = 0
        column_letter = column[0].column_letter
        for cell in column:
            if cell.value:
                max_length = max(max_length, len(str(cell.value)))
        adjusted_width = min(max_length + 2, 50)
        ws.column_dimensions[column_letter].width = adjusted_width

    # Save file
    wb.save(output_path)

    return str(output_path)
```

Add method after export_analytics() and before export_all().
</action>
  <verify>
grep -n "def export_excel" src/export/analytics.py
</verify>
  <done>
DataExporter.export_excel() generates formatted Excel files with styled headers and auto-adjusted columns.
</done>
</task>

<task type="auto">
  <name>Task 3: Update export endpoint to support Excel</name>
  <files>src/api/app.py</files>
  <action>
Update GET /api/sessions/{session_id}/export/{format} endpoint (around line 1035):

1. Add "excel" to supported formats
2. Set correct media type for Excel downloads
3. Generate consistent filename format per user decision

```python
@app.get("/api/sessions/{session_id}/export/{format}")
async def export_session(session_id: str, format: str, current_user = Depends(get_current_user)):
    """Export session results in CSV, JSON, or Excel format."""
    from export.analytics import DataExporter

    user_id = current_user.id
    store = SessionStore(session_id, user_id=user_id)
    session = store.load_session()

    if not session:
        raise HTTPException(status_code=404, detail="Session not found")

    reports_dir = store.get_reports_dir()
    reports_dir.mkdir(parents=True, exist_ok=True)
    exporter = DataExporter(session, str(reports_dir))

    if format == "csv":
        path = exporter.export_csv()
        media_type = "text/csv"
    elif format == "json":
        path = exporter.export_json()
        media_type = "application/json"
    elif format == "excel":
        path = exporter.export_excel()
        media_type = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    else:
        raise HTTPException(
            status_code=400,
            detail=f"Unsupported format: {format}. Supported: csv, json, excel"
        )

    def iterfile():
        with open(path, "rb") as f:
            yield from f

    filename = Path(path).name
    return StreamingResponse(
        iterfile(),
        media_type=media_type,
        headers={
            "Content-Disposition": f"attachment; filename={filename}"
        }
    )
```

The filename is already generated correctly by export_excel() with the format: `correction_YYYY-MM-DD_sessionid.xlsx`
</action>
  <verify>
grep -n "elif format == \"excel\"\|application/vnd.openxmlformats" src/api/app.py
</verify>
  <done>
Export endpoint supports CSV, JSON, and Excel formats with proper media types and filename headers.
</done>
</task>

<task type="auto">
  <name>Task 4: Enhance CSV export to include feedback</name>
  <files>src/export/analytics.py</files>
  <action>
Verify existing export_csv() method includes all required fields per EXPT-04:

Required fields:
- Student identifiers (student_name or copy_id)
- Grades per question
- Total score
- Feedback

Check the export_csv() method (around line 388-438). It should already have:
- Header: ["copy_id", "student_name", "total_score", "max_score", ...questions..., "feedback"]
- Data rows with all fields

If any field is missing, add it. The current implementation looks complete but verify feedback is included:
- Line 435: `row.append(graded.feedback or "")`

If the feedback field is missing, add it to the header and data rows.

Also verify CSV uses French decimal separator (comma) if needed for Excel compatibility in France. For v1, standard CSV format is acceptable.
</action>
  <verify>
grep -A5 "writer.writerow(header)" src/export/analytics.py | grep feedback
</verify>
  <done>
CSV export includes student identifiers, per-question grades, total, max score, and feedback.
</done>
</task>

</tasks>

<verification>
1. Complete a grading session with at least 3 students and 5 questions
2. Export CSV: `curl -O http://localhost:8000/api/sessions/{id}/export/csv -H "Authorization: Bearer $TOKEN"`
3. Verify CSV contains: student_name, all question columns, total, feedback
4. Export JSON: `curl -O http://localhost:8000/api/sessions/{id}/export/json -H "Authorization: Bearer $TOKEN"`
5. Verify JSON contains complete session data with dual-LLM audit
6. Export Excel: `curl -O http://localhost:8000/api/sessions/{id}/export/excel -H "Authorization: Bearer $TOKEN"`
7. Open Excel file and verify:
   - Styled header row (bold blue background)
   - All students with per-question grades
   - Feedback column populated
   - Column widths auto-adjusted
   - Filename format: correction_YYYY-MM-DD_XXXXXXXX.xlsx
</verification>

<success_criteria>
1. openpyxl dependency installed and imported
2. DataExporter.export_excel() generates formatted Excel files
3. Export endpoint supports /csv, /json, /excel URL paths
4. CSV includes student identifiers, grades, totals, feedback
5. JSON includes complete session data with dual-LLM audit trail
6. Excel includes styled headers, all data columns, feedback
7. Filenames follow consistent format with date and session ID
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-grading-experience/03-04-SUMMARY.md` with:
- openpyxl installation notes
- Excel export styling and formatting details
- Export format comparison (CSV vs JSON vs Excel)
</output>
